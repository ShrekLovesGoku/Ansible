---
- name: Create VMs in Proxmox from Template
  hosts: PXEAnsibleDC-Proxmox
  gather_facts: false
  vars:
    # Proxmox API credentials with username and password
    proxmox_api_host: "https://10.80.15.32:8006/api2/json"
    proxmox_api_user: "root@pam"  # Replace with your Proxmox API username
    proxmox_api_password: "Zli12345"  # Replace with your Proxmox API password
    # VM specifics
    vm_node: "diego-proxmox-srv"
    vm_id_start: 2000  # Start-ID for the new VMs
    vm_name_prefix: "vm-auto-"  # Prefix for the new VMs
    vm_template_vmid: 1000  # ID of the existing template to clone
    vm_count: 3  # Number of VMs to create

  tasks:
    - name: Clone VMs from Template
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: "{{ vm_node }}"
        vmid: "{{ vm_id_start + vm_index }}"
        name: "{{ vm_name_prefix }}{{ '%04d' | format(vm_index + 1) }}"
        template: "{{ vm_template_vmid }}"  # Use 'template' instead of 'clone_id'
        state: present
      loop: "{{ query('sequence', 'start=' ~ vm_id_start ~ ' count=' ~ vm_count) | map('int') }}"
      loop_control:
        loop_var: vm_index

    - name: Start cloned VMs
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: "{{ vm_node }}"
        vmid: "{{ vm_id_start + vm_index }}"
        state: started
      loop: "{{ query('sequence', 'start=' ~ vm_id_start ~ ' count=' ~ vm_count) | map('int') }}"
      loop_control:
        loop_var: vm_index