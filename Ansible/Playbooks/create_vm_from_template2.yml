---
- name: Create multiple VMs using Cloud-Init and DHCP configuration
  hosts: PXEAnsibleDC-Proxmox
  gather_facts: false

  vars:
    vm_count: 3  # Anzahl der zu erstellenden VMs
    base_name: "VM-auto"
    starting_id: 2001  # Start-ID f√ºr die VMs
    ansible_python_interpreter: "/root/proxmoxer-venv/bin/python3"
    ssh_keys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDGyGcs9d+jS/8bCkEwT71UJ44qTDENHgDvbxSdF6yzazrzfn11jAByxIgyKbPc0OmcXS6FrHoYnotAljJUeSwj7Cp0AoVhbiftE5f2NNFsJry6t9Ke9npe92UByhmJfLfDo06u+RTi/Bb9GWp8WMO2rxPE49gYOiIOZCbYFON3VNVmotfmVCxE9Me+/TgN4N8AsKQVqjLPATMhseWx7JQRJ1ZuUiG1eGaW+08Lc7NxpS28EMnf56/a0NPQnQcqO89IITPaijMG96v7sU97lbPwGG6tXcSDC8pBL8kSHozHbZWKmCdAVSDuirnjBEBZpBjnbUiWVqLw1Xay1oaLM0PPXNOTb8OzVeDBFsN+B1WPpvPHPh+PwwSnkSV2lSi48/z2A3ue5A0FQEdXYeHg7NoKVQ4cAyR698DLywr0cqAbei2z745fvXgH748mq0Fcz1gflClQh70RCzcEmN0KFNbjRpP/BwIBM9UiGjSZUnBV29upakHhvneE5cPPlG/g8H0= root@Ansible-CT-01"
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCjsmQjgLKrc+WsVtn1BF+s5NE/++1JKlYEt0hUe5UR0pw/SlIjpJBLr6/S275Qf20QshBc28Kz3j7JyvGa2FVGMrESvLl8F0V7Zba+ypE5E86Gqij8efwf54Gl/BFhvFxsIi/URmlJdT+9vz0GDYAySUBqooIowbnvX8QKiO54qTixdSRBw2DQG5dNN4jbnGrVbhYI16iQ3g5E7NaB382Z9+gfoJTFWYVR1NyiZnzrIL9T6pWdWpcG5t3ZKPq7FPp7DOI0pD8EPFTXqG8HfVzfk1Tk7SyzIqq9RQGa1ePeui1xaR+Vu9B8oqqph7gSXc6EqKiYpMMeLwNrNVZh/RR5ecglHUmqJoQ9JlgsvDnJmEjgPC8aO04UlI/cjIkRG30kthX3UtOv75eszOSWBgpLlvwkty/QB6va1wpPQug5JC0jW6/G9s09dTVPLbGZaOcg9EDBOmaBAb98pGeLlDsSc0ArcfDcGMXOewhSj7PG9uRKcg7AA81i/FoMDUsaykFuD2GaS/egMXWanYIrou4LljRl3MwjDKrY3YZbL1ywwg09bVEMijBdk5bGSZgiyJ26lQDdXiMr9v+k45NGwroP0Kmo4K3fKwNE/cGGO08eCsOV9BVPqX734pBHUkDwtjq0uZ+YG7wpdeNOH5TamJ4fUbHRZ4YPcHcYj/3LdguqRQ== root@diego-proxmox-srv"

  tasks:
    - name: Loop through to create VMs
      ansible.builtin.proxmox_kvm:
        node: diego-proxmox-srv
        api_user: root@pam
        api_password: Zli12345
        api_host: 10.80.15.32
        name: "{{ base_name }}-{{ starting_id + item }}"
        vmid: "{{ starting_id + item }}"
        ide:
          ide2: 'local:cloudinit,format=qcow2'
        ciuser: "user{{ starting_id + item }}"
        cipassword: "password{{ starting_id + item }}"
        sshkeys: "{{ ssh_keys }}"
        net:
          net0: 'virtio,bridge=vmbr1'
        ipconfig:
          ipconfig0: 'dhcp'  # Set the first network interface to DHCP
        state: started
      loop: "{{ range(1, vm_count + 1) | list }}"
      loop_control:
        loop_var: item

    - name: Create new VM using Cloud-Init with provided configuration
      ansible.builtin.proxmox_kvm:
        node: diego-proxmox-srv
        api_user: root@pam
        api_password: Zli12345
        api_host: 10.80.15.32
        name: "{{ base_name }}-{{ starting_id + item }}"
        vmid: "{{ starting_id + item }}"
        ide:
          ide2: 'local:cloudinit,format=qcow2'
        ciuser: "user{{ starting_id + item }}"
        cipassword: "password{{ starting_id + item }}"
        sshkeys: "{{ ssh_keys }}"
        net:
          net0: 'virtio,bridge=vmbr1'
        ipconfig:
          ipconfig0: 'dhcp'  # Set the first network interface to DHCP
        state: present  # Hier wird nur die VM erstellt, nicht gestartet
      loop: "{{ range(1, vm_count + 1) | list }}"
      loop_control:
        loop_var: item