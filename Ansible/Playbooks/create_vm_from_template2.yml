---
- name: Create multiple VMs using Cloud-Init and DHCP configuration
  hosts: PXEAnsibleDC-Proxmox  # Da die Aktion auf dem Controller ausgeführt wird
  gather_facts: false  # Keine Fakten über den Host sammeln

  vars:
    vm_count: 3  # Anzahl der zu erstellenden VMs
    base_name: "VM-auto"
    starting_id: 2001  # Start-ID für die VMs

  tasks:
    - name: Loop through to create VMs
      ansible.builtin.proxmox_kvm:
        node: diego-proxmox-srv
        api_user: root@pam
        api_password: Zli12345
        api_host: 10.80.15.32
        name: "{{ base_name }}-{{ starting_id + item }}"
        vmid: "{{ starting_id + item }}"
        ide:
          ide2: 'local:cloudinit,format=qcow2'
        ciuser: "user{{ item }}"
        cipassword: "password{{ item }}"
        net:
          net0: 'virtio,bridge=vmbr1'
        ipconfig:
          ipconfig0: 'dhcp'  # Set the first network interface to DHCP
        state: started
      loop: "{{ range(1, vm_count + 1) | list }}"
      loop_control:
        loop_var: item

    - name: Create new VM using Cloud-Init with provided configuration
      ansible.builtin.proxmox_kvm:
        node: sabrewulf
        api_user: root@pam
        api_password: secret
        api_host: helldorado
        name: "{{ base_name }}-{{ starting_id + item }}"
        vmid: "{{ starting_id + item }}"
        ide:
          ide2: 'local:cloudinit,format=qcow2'
        ciuser: "user{{ item }}"
        cipassword: "password{{ item }}"
        net:
          net0: 'virtio,bridge=vmbr1'
        ipconfig:
          ipconfig0: 'dhcp'  # Set the first network interface to DHCP
        state: present  # Hier wird nur die VM erstellt, nicht gestartet
      loop: "{{ range(1, vm_count + 1) | list }}"
      loop_control:
        loop_var: item
